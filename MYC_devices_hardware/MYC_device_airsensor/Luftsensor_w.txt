Hinweis für die Textformat-Version; um diese Version im PDF Format zu lesen, laden Sie bitte https://www.dk1ri.de/dhw/Luftsensor_w.pdf

Luftsensor mit Funkschnittstelle für das MYC Protokoll

Author DK1RI, Version V01.0, 20250803
This paper is published in https://github.com/dk1ri  as well

Definitionen

https://dk1ri.de/myc/Definitions .txt  oder https://dk1ri.de/myc/Definitions .pdf (englisch)

Einleitung

Dies ist die Beschreibung eines Luftsensors mit dem Sensor CCS811 von ADAFRUIT TM
Dieses Gerät kann in einem MYC System verwendet werden, aber auch unabhängig davon mit (binären) Befehlen gesteuert werden. Die Steuerung kann seriell, USB oder über ein Funkinterface erfolgen. Die Befehle sind sind als announcements in der Datei announcements.bas im Bascom Programm beschrieben.
Zur Steuerung mit einem Browser: https://dk1ri.de/myc/webserver.pdf oder  https://dk1ri.de/myc/webserver.tx
Defaultmäßig sind alle Schnittstellen aktiv. Mit dem Initialisierungsbefehl können diese aber deaktiviert werden. Der Initialisierungsbefehl funktioniert aber immer. 
Das Gerät besteht aus einer Leiterplatte mit dem Prozessor und dem Funkinterface und dem Luft Sensor. Die Leiterplatte ist auch t für andere Geräte vorgesehen, auch für verschiedene Schnittstellen und unterschiedliche Stromversorgung. Das Funkinterface ist für verschiedene Funkmodule ausgelegt. Für eine spezielle Anwendung lässt sich die Hardware erheblich vereinfachen.
Zur Fernsteuerung über kurze Entfernungen kann ein Funkmodul angeschlossen werden:
https://www.dk1ri.de/dhw/Wireless_interface.pdf  oder https://www.dk1ri.de/myc/Wireless_interface.txt 
Zur Zeit (Juni 2025) gibt es kein funktionsfähiges Funkinterface !!
Die Unterlagen zum Feinstaubsensor ohne Funkmodul:
https://www.dk1ri.de/dhw/Luftsensor.pdf  oder  https://www.dk1ri.de/dhw/Luftsensor.txt Diese Version wird nicht weiter entwickelt.
Es wird unbedingt empfohlen, die Beschreibung des Sensors zu lesen. Die Grenzen der Genauigkeit und einige Befehle zur Konfiguration sind nur so verständlich.

Beschreibung

Die Stromversorgung ist 7- 9V, Stromaufnahme ca. 140mA max.
Die Steuerung kann über USB oder RS232 oder ein Funkinterface erfolgen.
Die Schaltung verwendet das ADAFRUIT CCS811 Modul (TM).
Es können die CO2 und TVO Werte ausgelesen werden. Weiterhin können die internen Register ausgelesen werden. Bei der Änderung des Modes sollten unbedingt die Vorgaben des Herstellers beachtet werden (Wartezeit). Details müssen im Datenblatt nachgelesen werden.

Einbindung in das MYC System

Details zum MYC System stehen in https://www.dk1ri.de/myc/MYC.pdff.
Die komplette Befehlsliste steht als  announcements in der Datei announcements.bas im Bascom Programm.

Fehlermeldungen

Der Befehl &HFC liefert den letzten Fehler im Format:
aktuelle Befehlsnummer - Fehler - Befehlsnummer beim Auftritt des Fehlers
Dazu werden die empfangenen Befehle von 0 bis 255 umlaufend gezählt.
Nach 254 korrekten Befehlen wird der Fehlereintrag gelöscht.

Hardware Reset

Ist der Reset Jumper JP5 beim Anlegen der Versorgungsspannung überbrückt, werden wieder die Defaultwerte eingelesen.

Watchdog

Es gibt einen kompletten Hardware -reset, wenn die Hauptschleife länger als 2 Sekunde dauert.
Zusätzlich gibt es drei weitere Watchdogs, die in der vorliegenden Firmware für Tests und „Testbetrieb“ nach ca 10 Sekunden ansprechen. Für den „nicht Test Betrieb“ sollte der Wert auf 1 Sekunde gesetzt werden.
Die Befehlseingabe und Ausführung muss in dieser Zeit beendet sein. Danach werden die bereits empfangenen Daten gelöscht. Dies soll falsche Eingaben vermeiden. Mit dem &HFC "letzten Fehler" Befehl kann man Eingabefehler sehen.
Bei einem I2C Lesebefehl müssen die Daten innerhalb dieser Zeit vom I2C Master abgeholt werden. Danach werden die Daten gelöscht. Neue Befehle können erst eingegeben werden, wenn alle  Daten abgeholt wurden oder die Watchdog Zeit abgelaufen ist. Wird die RS232 / USB Schnittstelle verwendet, werden die Daten sofort ausgegeben.

Software

Die Steuerung übernimmt ein AVR Mikrocontroller Atmega644.
Die Software wurde in BASCOM geschrieben https://www.dk1ri.de/dhw/Luftsensor_w_bascom.zip.
Um das Programm zu kompilieren, muss das Verzeichnis https://dk1ri.de/dhw/common_1.14.zip  in das Verzeichnis mit dem Programm kopiert werden.

Programmierung des Prozessors

Zur Programmierung des Prozessors ist ein 6poliger ISP Stecker JP6 vorgesehen.
Die Fuses müssen möglicherweise programmiert werden (JTAG abschalten!!). Prozessortyp und Frequenz müssen gegebenenfalls angepasst werden.
Der Jumper JP1 und sollte während der Programmierung entfernt werden; ebenso der Sensor und der Funkmodul.

Serielle (RS232 / USB) Schnittstelle

Für die RS232 Schnittstelle wird IC4 und C6 – C9 bestückt. Die seriellen Daten können an JP12 abgenommen werden. Schnittstellenparameter: 19k2 8N1
Alternativ zur RS232 Schnittstelle kann die USB Platine UM2102 von ELV verwendet werden. Die USB Platine wird plan auf der Oberseite der Interfaces verlötet: der USB Stecker zeigt zum Rand. Die 6 pins des Verbinders ST2  sind mit den 6Anschlusspunkten JP7 /JP8 auf dem Interface zu verbinden. USB Platine und Interface müssen voneinander isoliert werden.
Die Stromversorgung kann dann über USB erfolgen.

I2C Schnittstelle 

I2C kann zur Steuerung nicht verwendet werden, da der Klimasensor über I2C gesteuert wird.

Browser Schnittstelle

Es gibt einen (Windows) Webserver, an das Gerät direkt oder über die Funkschnittstelle angeschlossen wird. Die Bedienung erfolgt mit einem Browser, der auf den Webserver zugreift.
Details dazu stehen in  https://dk1ri.de/myc/webserver.pdf oder  https://dk1ri.de/myc/webserver.txt .
Ein Bildschirm Bild und nötige Daten für dieses Device stehen in https://dk1ri.de/w_dat.htm ,

Remote Bedienung (über Funk)

Zur Überbrückung kurzer Entfernungen kann eine Funkschnittstelle angeschlossen werden. Je nach verwendeter Funkschnittstelle muss die FU entsprechend programmiert werden. Vor der ersten Inbetriebnahme muss das gewünschte Funkmodul eingetragen und die Konfiguration vorgenommen werden  (JP12 verbunden). Danach entfernt man den Jumper für den normalen Betrieb.

SMD

Die Leiterplatte ist teilweise mit SMD bestückt.

Stromversorgung

Die externe Stromversorgung ist 7- 12V, Stromaufnahme ca. 30mA max (ohne Funkmodul).
Es wird bestückt: JP15, D1, C1, IC2. Wird für den Funkmodul zusätzlich 3V benötigt, muss auch DC1 und C11 bestückt werden.

Alternativ erfolgt die Stromversorgung über USB. Dann braucht JP15, D1, und C1 nicht bestückt werden; IC2 und DC1 dürfen nicht bestückt werden!!! Wenn wegen hoher Ströme die 9-12V Stromversorgung und auch USB benötigt wird, dürfen JP8 Pin 1 und 2 nicht mit dem USB Modul verbunden werden.

Bestückung der Leiterplatte

https://www.dk1ri.de/dhw/Wireless_interface_eagle.zip
Die Leiterplatten wireless_interface wird verwendet sind und nur teilweise bestückt. 
Zur Bestückung der wireless_modul Leiterplatte siehe https://www.dk1ri.de/dhw/Wireless_interface.pdf oder https://www.dk1ri.de/dhw/Wireless_interface.txt , wenn ein Funkmodul verwendet werden soll.

Verwendung von ISP:
JP6

Mit serieller Schnittstelle:
Siehe Serielle Schnittstelle oben

Externe Stromversorgung:
Siehe Stromversorgung oben.Mit serieller Schnittstelle:
Siehe Serielle Schnittstelle oben

Externe Stromversorgung:
Siehe Stromversorgung oben.

Außer den bereits erwähnten Bauteilen wird bestückt:  Q1, IC1, C2 – C5, C10 - C12, JP1, JP5, JP11, SV1 (mit Funkschnittstelle), JP13, JP21, JP22

Der Adafruit Modul CCS811wird auf JP21 / 22 pin5 angeschlossen.

Anschlüsse

Power
Tip	12V
Ring	GND

JP 12 (RS232)
1	GND
2	RX (PC Ausgang)
3	TX (PC Eingang)

Luftsensor (JP21 JP22)
JP21 pin1 VCC (Vin)
JP21 pin3 GND (GND)
JP21 pin4 SCL (SCL)
JP22 pin1 SDA (SDA)
JP22 pin4 GND (WAKE)
Die anderen Pins des Sensors (3v3, int, RST) dürfen nicht verbunden werden!

SV1	Funkmodul

Jumper

JP1 		Power
JP2 		I2C: 3V/5V Umschaltung
JP3		SDA Überbrückung (ohne IC3)
JP4		SCL Überbrückung (ohne IC3)
JP5		Reset
JP6		ISP 
JP7/8		Anschluss für USB Modul
JP9		3V vom USB Modul
JP10		5V vom USB Modul
JP11		MYC Transparent Mode
JP13		pin2 und pin3 überbrücken (SCL)

Versionen

Diese Beschreibung gilt für die
Leiterplattenversion (wireless interface) V02.3 https://dk1ri.de/dhw/wireless_interface_eagle.zip
Bascom Version V01.0
https://www.dk1ri.de/dhw/Luftsensor_w_bascom.zip

Copyright

Die Ideen in diesem Dokument unterliegen der GPL (Gnu Public Licence V2) soweit keine früheren, anderen Rechte betroffen sind.
Die Verwendung der Unterlagen erfolgt auf eigene Gefahr; es wird keinerlei Garantie / Gewährleistung / Produkthaftung  übernommen.
The ideas of this document can be used under GPL (Gnu Public License V2) as long as no earlier other rights are affected.
The usage of this document is on own risk, there is no warranty.

