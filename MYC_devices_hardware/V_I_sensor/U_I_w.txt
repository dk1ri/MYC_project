Hinweis für die Textformat-Version; um diese Version im PDF Format zu lesen, laden Sie bitte http://www.dk1ri.de/dhw/U_I.pdf

Spannung / Strom  Messung für das MYC Protokoll mit INA219

Author DK1RI, Version V03.0, 20251204
This project can be found in https://www.github.com/dk1ri

Definitionen

https://dk1ri.de/myc/Description.txtDefinitions .txt  oder https://dk1ri.de/myc/Definitions .pdf (englisch)

Einleitung

Diese FU verwendet das Adafruit Modul oder den pinkompatiblen Modul von Stemma.. Das Modul von Soldered kann auch verwendet werden, hat aber eine andere Pinbelegung.
Dieses Gerät kann in einem MYC System verwendet werden, aber auch unabhängig davon mit (binären) Befehlen gesteuert werden. Die Steuerung kann seriell, über USB oder über ein Funkinterface erfolgen. Die Befehle sind sind als announcements in der Datei announcements.bas im Bascom Programm beschrieben.
Zur Steuerung mit einem Browser: https://dk1ri.de/myc/webserver.pdf oder  https://dk1ri.de/myc/webserver.txt
Defaultmäßig sind alle Schnittstellen aktiv. Mit dem Initialisierungsbefehl können diese aber deaktiviert werden. Der Initialisierungsbefehl funktioniert aber immer. 
Das Gerät besteht aus einer Leiterplatte mit dem Prozessor und dem Funkinterface. Die Leiterplatte ist auch für andere Geräte vorgesehen, auch für verschiedene Schnittstellen und unterschiedliche Stromversorgung. Das Funkinterface ist für verschiedene Funkmodule ausgelegt. Für eine spezielle Anwendung lässt sich die Hardware erheblich vereinfachen.
Zur Fernsteuerung über kurze Entfernungen kann ein Funkmodul angeschlossen werden:
http://www.dk1ri.de/dhw/Wireless_interface.pdf  oder http://www.dk1ri.de/dhw/Wireless_interface.txt 
Zur Zeit (Dezember 2025) funktioniert Lora mit RFM95 und 2,4GHz ISM mit nRF24

Beschreibung und Bedienung

Das Messgerät misst Spannungen von 0 – 25V (4mV Auflösung) und Ströme bis 3,2A (100uA Auflösung).
Die Bedienung mit dem Browser ist weitestgehend selbsterklärend.
Strom und Shuntspannung erfolgt durch Messung an Vin+ und Vin-. Zur Spannungsmessung wird Vin- und GND (der Stromversorgung) verwendet. Um die Leistung zu messen, muss Vin+ , Vin- und GND verbunden sein. Die Spannung an Vin+ und Vin+ muss 0 - +25V gegen GND sein. Die Spannung zwischen Vin+ und Vin- kann positiv oder negativ sein, muss aber kleiner als 320mV sein da der Strom auf 3,2A begrenzt ist (zwischen Vin+ und Vin- liegt ein Widerstand von 0,1Ohm).
Bei der Leistungsmessung ist zu beachten, dass dazu 2 Messungen nötig sind.
Der Modul hat keine Filter zur Unterdrückung von Spannungs- und Stromschwankungen und auch keinen Schutz gegen Verpolung oder Überspannung.
Zum genauen Eichung kann der Wert des Configuration register geändert werden. Die Vorgehensweise dafür ist im Datenblatt des INA219 beschrieben. Bei meinen Moduln werden die Spezifikationen der Genauigkeit leicht überschritten.


Einbindung in das MYC System

Details zum MYC System stehen in https://www.dk1ri.de/myc/MYC.pdf .
Die komplette Befehlsliste steht als  announcements in der Datei announcements.bas im Bascom Programm.

Fehlermeldungen

Der Befehl &HFC liefert den letzten Fehler im Format:
aktuelle Befehlsnummer - Fehler - Befehlsnummer beim Auftritt des Fehlers
Dazu werden die empfangenen Befehle von 0 bis 255 umlaufend gezählt.
Nach 254 korrekten Befehlen wird der Fehlereintrag gelöscht.

Hardware Reset

Ist der Reset Jumper JP5 beim Anlegen der Versorgungsspannung überbrückt, werden wieder die Defaultwerte eingelesen.

Watchdog

Es gibt einen kompletten Hardware -reset, wenn die Hauptschleife länger als 2 Sekunde dauert.
Zusätzlich gibt es drei weitere Watchdogs, die in der vorliegenden Firmware für Tests und „Testbetrieb“ nach ca 10 Sekunden ansprechen. Für „nicht Test Betrieb“ sollte der Wert auf 1 Sekunde gesetzt werden.
Die Befehlseingabe und Ausführung muss in dieser Zeit beendet sein. Danach werden die bereits empfangenen Daten gelöscht. Dies soll falsche Eingaben vermeiden. Mit dem &HFC "letzten Fehler" Befehl kann man Eingabefehler sehen.

Firmware

Die Steuerung übernimmt ein AVR Mikrocontroller Atmega1284.
Die Software wurde in BASCOM geschrieben http://www.dk1ri.de/dhw/U_I_w_bascom.zip
Dort gibt es einen Hex Datei zur Programmierung des ATMEGA
Um das Programm zu kompilieren, muss das Verzeichnis common_V01.14 in das Verzeichnis mit dem Programm kopiert werden. Die aktuelle gültige Version steht im Bacom Programm.

Programmierung des Prozessors

Zur Programmierung des Prozessors ist ein 6poliger ISP Stecker JP6 vorgesehen.
Die Fuses müssen möglicherweise programmiert werden (JTAG abschalten!!). Prozessortyp und Frequenz müssen gegebenenfalls angepasst werden.
Der Jumper JP1 und sollte während der Programmierung entfernt werden; ebenso der Sensor und der Funkmodul.


Serielle (RS232 / USB) Schnittstelle

Für die RS232 Schnittstelle wird IC4 und C6 – C9 bestückt. Die seriellen Daten können an JP12 abgenommen werden. Schnittstellenparameter: 19k2 8N1
Alternativ zur RS232 Schnittstelle kann die USB Platine UM2102 von ELV verwendet werden. Die USB Platine wird plan auf der Oberseite der Interfaces verlötet: der USB Stecker zeigt zum Rand. Die 6 pins des Verbinders ST2  sind mit den 6Anschlusspunkten JP7 /JP8 auf dem Interface zu verbinden. USB Platine und Interface müssen voneinander isoliert werden.
Die Stromversorgung kann dann über USB erfolgen.

I2C Schnittstelle 

Die I2C Schnittstelle wird für den INA219 verwendet und kann daher nicht zur Gerätesteuerung verwendet werden.

Browser Schnittstelle

Es gibt einen (Windows) Webserver, an das Gerät direkt oder über die Funkschnittstelle angeschlossen wird. Die Bedienung erfolgt mit einem Browser, der auf den Webserver zugreift.
Details dazu stehen in  https://dk1ri.de/myc/webserver.pdf oder  https://dk1ri.de/myc/webserver.txt .
Ein Bildschirm Bild und nötige Daten für dieses Device stehen in https://dk1ri.de/w_dat.htm ,

Remote Bedienung (über Funk)

Zur Überbrückung kurzer Entfernungen kann eine Funkschnittstelle angeschlossen werden. Je nach verwendeter Funkschnittstelle muss die FU entsprechend programmiert werden (JP11 überbrückt). Es muss zumindest das gewünschte Funkmodul, Name und Frequenz eingetragen angepasst werden. Danach entfernt man den Jumper für den normalen Betrieb.

SMD

Die Leiterplatte ist teilweise mit SMD bestückt

Stromversorgung

Die Stromversorgung erfolgt mit 7 -12V oder 5V über JP10 oder eine USBmicro Buchse. Bei 12V Versorgung wird  JP10, D1, und C1 und IC2 bestückt. Wenn 3V benötigt werden, wird der Regler IC5 verwendet. Dies ist ein 78xx kompatibler Schaltregler.
Alternativ erfolgt die Stromversorgung über USB. IC2 und IC5 dürfen dann nicht bestückt werden! Wenn wegen hoher Ströme die 7-12V Stromversorgung und auch USB benötigt wird, dürfen JP8 Pin 1 und 2 nicht mit dem USB Modul verbunden werden.

Bestückung der Leiterplatte 

 http://www.dk1ri.de/dhw/Wireless_interface_eagle.zip
Die Leiterplatte ist für verschiedene Konfigurationen ausgelegt und wird daher normalerweise nur teilweise bestückt. Für genau definierte Anwendungen können die Leiterplatten verkleinert werde

Verwendung von ISP:
JP6

Mit serieller Schnittstelle:
Siehe Serielle Schnittstelle oben

Externe Stromversorgung:
Siehe Stromversorgung oben.

Außer den bereits erwähnten Bauteilen wird immer bestückt: Q1, IC1, U1, C2 – C5, C10 - C12, JP1, JP5, JP11, JP32, JP33 - JP38

Der Adafruit Modul wird an JP21 / JP22 angeschlossen, Die Pins Vin+ und Vin- dürfen nicht verbunden werden !!! Der Anschluss zum Messen von Strom Spannung erfolgt über die Schraubkontakte des Moduls.

Anschlüsse

JP15 (Power)
1	GND
2	12V

JP 12 (RS232)
1	GND
2	RX (PC Ausgang)
3	TX (PC Eingang)

Adafruit U/I Sensor (JP37 JP38) Steckanschluss
JP37 2		5V
JP37 3		GND
JP37 4 		SCL
JP38 1		SDA
Vin+ und Vin- dürfen nicht verbunden werden !!!

Soldered U/I Sensor (JP37 JP38)
JP37 2		5V
JP37 3		GND
JP37 4		SCL Anschluss über Draht
JP38 1		SDA Anschluss über Draht

Jumper

JP1 		Power
JP5		Reset
JP6		ISP 
JP7/8		Anschluss für USB Modul
JP11		Konfiguration
JP35		pin 2 und pin3 überbrücken (SCL)
JP36		pin 2 und pin3 überbrücken (5V)

Versionen

Diese Beschreibung gilt für die
Leiterplattenversion (wireless_interface) V05.0 https://dk1ri.de/dhw/Wireless_interface_eagle.zip
Bascom Version V03.0
http://www.dk1ri.de/dhw/U_I_w_bascom.zip


Copyright

Die Ideen in diesem Dokument unterliegen der GPL (Gnu Public Licence V2) soweit keine früheren, anderen Rechte betroffen sind.
Die Verwendung der Unterlagen erfolgt auf eigene Geafahr; es wird keinerlei Garantie übernommen.
The ideas of this document can be used under GPL (Gnu Public License V2) as long as no earlier other rights are affected.
The usage of this document is on own risk, there is no warranty.
