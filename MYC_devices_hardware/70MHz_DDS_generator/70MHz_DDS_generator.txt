Hinweis für die Textformat-Version; um diese Version im PDF Format zu lesen, laden Sie bitte http://www.dk1ri.de/dhw/70MHz_DDS_generator.pdf


70MHz DDS Generator

Author DK1RI, Version V03.4, 20240805
This paper is published in https://github.com/dk1ri  as well

Einleitung

Dies ist die Beschreibung eines 70MHz DDS Generators mit dem AD9851 von Analog Devices.
Dieses Gerät kann als universeller Sender mit Steuerung mit serieller Schnittstelle / I2C verwendet werden. Die Steuerung über Infrarot ist zur Zeit nicht aktiv.
Das Gerät kann in einem MYC System verwendet werden, aber auch unabhängig davon mit (binären) Befehlen gesteuert werden. Die Befehle sind sind als announcements in der Datei announcements.bas im Bascom Programm beschrieben.
Zur Steuerung mit einem Browser: siehe [10] und [11]
Das Interface arbeitet als Slave am I2C Bus oder kann über RS232 / (USB) gesteuert werden.
Defaultmäßig sind alle Schnittstellen aktiv. Mit dem Initialisierungsbefehl können diese aber deaktiviert werden. Der Initialisierungsbefehl funktioniert aber immer. 

Beschreibung und Bedienung

Allgemeines:
Ursprünglich benötigte ich einen Steuersender, der wenige einzelne Frequenzen in den Amateurfunkbändern liefert. Dieser sollte einen 10W Verstärker [7] ansteuern, um die Abstimmung eines automatischen Antennen - Anpassgerätes zu ermöglichen. 
Der Betrieb in dieser Form ist eine gültige Amateurfunklizenz erforderlich!
Das Gerät kann auch als universell steuerbarer Generator verwendet werden..
Die Eagle Daten für die Leiterplatte stehen unter  [1].
Die Stromversorgung ist 12V +-10%, Stromaufnahme ca. 140 mA max. Hinzu kommt der Strom des 10W Verstärkers (<2A) und des Relais.
Die Steuerung kann über I2C, USB oder RS232 oder (eingeschränkt) Infrarot erfolgen.

Details:
Der Befehl &H03 bestimmt, ob der Verstärker ausgeschaltet ist und das Signal von „from_TX“ nach „PAout“ durchgeschaltet wird; oder das verstärkte Signal des Generators an „PAout“ erscheint.	
Mit Verstärker ist „Sinusout“ mit dem Eingang des Verstärkers verbunden; der Ausgang mit „Out“:
Beim ersten Einschalten sendet der Generator bei 10MHz.
Der Generator ist nicht abschaltbar.

Als Testsender
Der automatische Antennenanpassgerät MFJ 998RT benötigt zur Abstimmung eine Spannung, die einer Leistung von 5 – 8W entspricht. Wenn das Anpassgerät schon auf eine Antenne abgestimmt war, geht die Anpassung an eine geänderte Frequenz zwar sehr schnell. Die verwendete Endstufe SPE, 1,3kW schaltet bei Fehlanpassung aber schneller ab und auch der Transceiver IC705 regelt zu weit zurück, und das Anpassgerät funktioniert so nicht. Daher wird ein Sender verwendet, der nicht zurückgeregelt und bei Fehlanpassung nicht zerstört wird.
Nach dem Einschalten soll das Relais ausgeschaltet sein. Das Sendesignal wird von SL7 auf SL6 durchgeleitet. Dort ist ddie Endstufe mit dem Anpassgerät angeschlossen. Dies ist die Einstellung für den normalen Sendebetrieb.
Bei Fehlanpassung schaltet die Endstufe ab und auf Durchgang oder man schaltet sie manuell auf Durchgang. Das Relais wird eingeschaltet, die LED geht an.Der Verstärker schaltet ein. Der DDS Generator gibt eine geeignete Frequenz aus. Das Ausgangssignal an SL4 geht auf einen 10W QRP Verstärker [7], der nicht zurückregelt. Das Ausgangssignal des Verstärkers geht über SL5 – SL6 durch die Endstufe an das Anpassgerät. Die maximale Eingangleistung der Endstufe (10W) wird auch nicht überschritten, falls die Endstufe nicht abgeschaltet wurde. 
Nach dem Abstimmvorgang wird der Verstärker wieder abgeschaltet (Relais aus)
In der bestehenden Softwareversion sind 19 voreingestellte  Frequenzen vorgesehen.
Der verwendete Verstärker benötigt 400mVpp (140mVeff) zur Aussteuerung bei 10MHz, bei 30MHz etwa 1Vpp.
Der Ausgangspegel des DDS Generators beträgt 1Vpp an 50Ohm. Mit R6 = R7 = 100Ohm ergibt sich 1Vpp an 50Ohm. Dieser Pegel kann direkt verwendet werden: (R8 = 0 Ohm R9 = -)

Infrarot:
Die Steuerung per Infrarot ist zur Zeit deaktiviert
Zunächst muss man dazu die RC5 Adresse und die Kommandonummern zu den Tasten herausfinden.  
Den zuletzt empfangene Adresse und den Code kann man mit  &H11 auslesen.
Die Adresse wird eingegeben mit 0x11<adresse> (im Hex format)
zum Beispiel: &H1100
Der code mit &H13<position><code> (im Hex format)

<position>					default code
&H00:		Code für 10000000Hz	1		1
&H01:		Code für 151000 Hz		2
&H02:		Code für 3510000 Hz		3
&H03:		Code für 3650000 Hz		4
&H04:		Code für 3790000 Hz		5
&H05:		Code für 7100000 Hz		6
&H06:		Code für 10065000 Hz	7
&H07:		Code für 14050000 Hz	8
&H08:		Code für 14175000 Hz	9
&H09:		Code für 14345000 Hz	0
&H0A:	Code für 18065000 Hz	56
&H0B:		Code für 21050000 Hz	34
&H0C: 	Code für 21200000 Hz	87
&H0D:	Code für 21445000 Hz	33
&H0E:		Code für 24050000 Hz	32
&H0F:		Code für 28050000 Hz	12
&H10:		Code für 28700000 Hz	17
&H11:		Code für 29200000 Hz	16
&H12:		Code für 50100000 Hz	41
&H13:		Code für 51900000 Hz	46

RC5 Adresse und  Kommandonummern können über die Schnittstellen /Browser geändert werden.
Werden weniger Frequenzen benötigt, werden bei den nicht benötigten Commx ungültige RC5 Codes eingetragen.

Universeller Generator
Die Bedienung mit dem Browser ist weitestgehend selbsterklärend. Die folgenden Befehlsangaben gelten bei Steuerung über die serielle / I2C Schnittstelle.
Neben den Standardbefehlen sind 27 weitere Befehle vorgesehen: für das Einstellen der Frequenz, das Schalten des Relais / des Verstärkers, die Eichung und die Eingabe der RC5-Adressen. Weiterhin einige Befehle zum Auslesen der Daten.
Wenn der Temperatursensor eingebaut ist und mit &H0701 aktiviert wurde, wird die Temperatur circa alle 30 Sekunden gemessen. Wenn ein Temperaturkoeffizient des Oszillators eingegeben wurde, wird dieser bei jeder Änderung der Frequenz und Temperatur berücksichtigt.
Mit dem Relais wird der Verstärker aktiviert.
Weitere Details stehen bei „ Eichung“.
Es wird empfohlen, ein abschirmendes Gehäuse zu verwenden.

Einbindung in das MYC System

Details zum MYC System stehen in [3].
Die komplette Befehlsliste steht als  announcements in der Datei announcements.bas im Bascom Programm.

Fehlermeldungen

Der Befehl &HFC liefert den letzten Fehler im Format:
aktuelle Befehlsnummer - Fehler - Befehlsnummer beim Auftritt des Fehlers
Dazu werden die empfangenen Befehle von 0 bis 255 umlaufend gezählt.
Nach 254 korrekten Befehlen wird der Fehlereintrag gelöscht.

Reset

Ist der Reset Jumper JP5 beim Anlegen der Versorgungsspannung überbrückt, werden wieder die Defaultwerte eingelesen. Dies ist hilfreich, wenn die aktuelle I2C Adresse verloren gegangen ist.

Watchdog

Es gibt einen kompletten Hardware-reset, wenn die Hauptschleife länger als 2 Sekunde dauert.
Zusätzlich gibt es drei weitere Watchdogs, die in der vorliegenden Firmware für Tests nach ca 10 Sekunden ansprechen. Für „MYC Betrieb“ sollte der Wert auf 1 Sekunde gesetzt werden.
Die Befehlseingabe und Ausführung muss in dieser Zeit beendet sein. Danach werden die bereits empfangenen Daten gelöscht. Dies soll falsche Eingaben vermeiden. Mit dem &HFC "letzten Fehler" Befehl kann man Eingabefehler sehen.
Bei einem I2C Lesebefehl müssen die Daten innerhalb dieser Zeit vom I2C Master abgeholt werden. Danach werden die Daten gelöscht. Neue Befehle können erst eingegeben werden, wenn alle  Daten abgeholt wurden oder die Watchdog Zeit abgelaufen ist. Wird die RS232 / USB Schnittstelle verwendet, werden die Daten sofort ausgegeben.
Bei einem I2C BusLock (SDA pin auf 0) erfolgt auch ein I2C reset.

Software

Die Steuerung übernimmt ein AVR Mikrocontroller Atmega328 oder größer.
Das aktuelle Bascom Programm verwendet einen Atmega328P.
Die Software wurde in BASCOM geschrieben [2]
Um das Programm zu kompilieren, muss das Verzeichnis common_1.13 [6] in das Verzeichnis mit dem Programm kopiert werden

Programmierung des Prozessors

Zur Programmierung des Prozessors ist ein 6poliger ISP Stecker JP6 vorgesehen.
Die Fuses müssen möglicherweise programmiert werden (siehe Bascom Programm) !! Prozessortyp und Frequenz müssen gegebenenfalls angepasst werden.
Der Jumper J1 sollte während der Programmierung entfernt werden.

Serielle (RS232 / USB) Schnittstelle

Schnittstellenparameter: 19k2 8N1.
Alternativ zur RS232 Schnittstelle kann die USB Platine UM2102 von ELV verwendet werden. Die USB Platine wird plan auf der Oberseite der Interfaces verlötet: der USB Stecker zeigt zum Rand. USB Platine und Leiterplatte müssen voneinander isoliert werden.

I2C

Die Default Adresse ist 37 (&H25).
Mit dem Befehl &HFE03<n> kann die Adresse in n (1 … 127) geändert werden.
Pullup Widerstände R3 / R4 müssen immer bestückt werden (1k – 10k).
Mit JP2 kann festgelegt werden, ob der externe I2C Bus mit 3V oder 5V betrieben wird.
Wenn auf den 3V Betrieb völlig verzichtet werden soll, kann IC3 (PCA9517), R1, R2, R5, R6, JP2 entfallen und alternativ wird JP3 und JP4 bestückt. 
Ganz ohne I2C kann auch SL1, SL2, JP2, JP3, JP4, R1, R2, R5, R6 entfallen. 
Der Gesamtwiderstand am I2C Bus sollte bei 1 bis 10 kOhm je nach Leitungslänge liegen
Mit IC3 muss R1 / R2 (<=10k) bestückt werden. 
SL1 und SL2 sind parallel geschaltet. Ein Anschluss kann zur Weitergabe des I2C Signals an das nächste Gerät verwendet werden. 
Um Buslocks zu vermeiden, wird circa alle 200ms geprüft, ob das SDA Signal auf „0“ liegt.
Ist das 50 mal hintereinander der Fall, wird die I2C Schnittstelle neu gestartet.


Browser Schnittstelle

Es gibt einen (Windows) Webserver, an das Gerät angeschlossen wird. Die Bedienung erfolgt mit einem Browser, der auf den Webserver zugreift.
Details dazu stehen in [10].
Ein Bildschirm Bild und nötige Daten für dieses Device stehen in [11] und [12].

SMD

Die Leiterplatte ist teilweise mit SMD bestückt.

Stromversorgung

Die Stromversorgung ist 12V +-10%, Stromaufnahme ca. 140mA + Strom der PA + Relais

Eichung

Die Eichung sollte zumindest einmal durchgeführt werden.
Eine definierte möglichst hohe Frequenz wird eingestellt und gemessen und mit &H08xxxxxx eingegeben.
&H0A speichert den Wert der Abweichung, der dann immer verwendet wird. Gegebenenfalls wird die zugehörige Temperatur gespeichert.
Ein Temperatursensor ist zur Temperaturkompensation vorgesehen. Dieser muss bestückt und aktiviert sein (&H0501).
Die Temperatur wird mit &H07 in 1/10 Grad  ausgelesen.
Die gemessene Temperatur ist etwa 25 Grad höher als die Umgebungstemperatur nach einigen Minuten Betrieb.
Zur Messung der Temperaturdrift muss Tkmessung eingeschaltet sein: &H0A01; damit ist eine eventuell bestehende Temperaturkompensation nicht aktiv.
Die Temperatur und die Frequenz wird bei zwei möglichst weit auseinanderliegenden Temperaturen und möglichst hoher Frequenz gemessen und eingetragen. Die Temperaturen werden mit &0C00 (niedrige Temperatur) und 0H0C01 (hohe Temperatur)  gemessen. Die gemessenen Frequenzen werden mit &H0D (bei Tmin) und &H0E (bei Tmax) eingegeben. Der Temperaturkoeffizient wird mit &H0F berechnet und kann mit 0H10 ausgelesen werden. Der Wert wird sofort berücksichtigt, wenn der Wert < +- 1/10 %/K ist und die Tkmessung wieder abgeschaltet ist.
Der Temperatursensor hat eine gewisse Trägheit. Es dauert circa 1 Minute, bis eine Temperatur richtig gemessen wird.

Bestückung der Leiterplatte

Verwendung von ISP:
JP6

Den 30MHz Quarzoszillator gibt es für verschiedene Versorgungsspannungen. Wird ein 5V Typ verwendet, muss IC9 (3,3V Regler) entfallen. Pin2 und Pin3 von IC9 wird dann überbrückt. I2C mit 3V ist dann nicht möglich.

Wird für IC9 (MCP1700-3302) ein 78L03 kompatibler Regler verwendet, ist  die Reihenfolge der pins unterschiedlich !!!

Der Bestückungsaufdruck der Temperatursensors ist falsch (um 180 Grad gedreht)!

Mit I2C:
Siehe I2C oben.

Mit serieller Schnittstelle:
Bei Verwendung der RS232 Schnittstelle wird IC4, C6 – C9 und SL3 bestückt. Alternativ dazu kann der USB Modul UM2102  verwendet werden.
Der USB Modul wird isoliert auf der Bestückungsseite angebracht,. Die mittleren 4 Anschlüsse werden mit JP8 verlötet.

Wenn das Relais und der Verstärker nicht benötigt wird, wird kann K2 T1 – T3, D5, R14, R17, R50, SL5, SL6, SL7, SL9, SL10 entfallen.
Der Transistor T3 kann bis zu 4A schalten (IRLML2244). Das reicht für eine 10W Endstufe.
Die Diode D1 muss auch eine entsprechende Strombelastbarkeit haben und kann auch überbrückt werden. Dabei entfällt aber der Verpolungsschutz.
Mit Verstärker wird der Eingang mit SL4 verbunden; der Ausgang mit SL6.
Das DDS Sinusausgangssignal liegt an SL4, das Rechtecksignal an SL6.

Anschlüsse

12V Power / (SL12)
Tip	12V
Ring	GND
1,2	GND
3	12V

I2C (SL1, SL2)
1	GND
2	SCL
3	SDA

RS232 (SL3)
1	GND
2	Eingang
3	Ausgang

Sinusout (SL4 zum Verstärker oder direkter Ausgang)
1	GND
2	Signal

PA_Out (SL5  zur Matchbox)
1	GND
2	Signal

Out (SL6  vom Verstärker)
1	GND
2	Signal

from_Tx (SL7)
1	GND
2	Signal


COM_Out (SL8)
1	GND
2	Signal
3	Signal invertiert

12VPA (SL9 für Verstärker)
1	GND
2	-
3	12V  geschaltet

LED	(SL10)
1	GND
2	-
3	LED

Relais (SL11, schaltet Relais und Verstärker)
1	GND
2	-
3	Signal

Infrarot (SL13)
1	GND
2	Daten
3	5V

Jumper

JP1 		Power
JP2 		I2C: 3V/5V Umschaltung
JP3		SDA Überbrückung (ohne IC3)
JP4		SCL Überbrückung (ohne IC3)
JP5		Reset
JP6		ISP 
JP8		Anschluss für USB Modul

Versionen

Diese Beschreibung gilt für die
Leiterplattenversion V03.0
Bascom Version V03.4

Copyright

Die Ideen in diesem Dokument unterliegen der GPL (Gnu Public Licence V2) soweit keine früheren, anderen Rechte betroffen sind.
Die Verwendung der Unterlagen erfolgt auf eigene Gefahr; es wird keinerlei Garantie / Gewährleistung / Produkthaftung  übernommen.
The ideas of this document can be used under GPL (Gnu Public License V2) as long as no earlier other rights are affected.
The usage of this document is on own risk, there is no warranty.

Referenzen
[1]	https://www.dk1ri.de/dhw/70MHz_DDS_generator_eagle.zip
[2]	https://www.dk1ri.de/dhw/70MHz_DDS_generator_bascom.zip
[3]	https://www.dk1ri.de/myc/MYC.pdf 
[4]	https://dk1ri.de/myc/Description.txt  oder https://dk1ri.de/myc/Description.pdf (englisch)
[5]	https://dk1ri.de/myc/Definitions.txt  oder https://dk1ri.de/myc/Definitions.pdf (englisch)
[6]	https://dk1ri.de/dhw/common_1.13.zip
[7]	https://kn-electronic.de/Bausaetze/FET-PA10.html
[8]	https://www.elektronik-labor.de/AVR/dds/AD9850.html
[9]	https://dk1ri.de/dhw/infrarot_tester.zip
[10]	https://dk1ri.de/myc/webserver.pdf
[11]	https://dk1ri.de/myc/wb0013.jpg
[12]	https://dk1ri.de/myc/wd0013.zip
